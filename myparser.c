#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "modules/csvparserlib.h"

typedef struct {
    int size;
    double **rates;
    const char **columns;
} csvData;

csvData getCSVData() {
    int i,j = 0;
    csvData csv;
    CsvParser *csvparser = CsvParser_new("data.csv", ",", 1);

    CsvRow *row;
    const CsvRow *header = CsvParser_getHeader(csvparser);
    const int size = CsvParser_getNumFields(header);
    csv.size = size;


    if (header == NULL) {
        printf("%s\n", CsvParser_getErrorMessage(csvparser));
        exit(1);
    }

    const char **headerFields = CsvParser_getFields(header);

    // Allocate Columns Array
    csv.columns = malloc(size * sizeof(char *));
    for(int i = 0; i < size; ++i)
    {
        csv.columns[i] = (char *) malloc(size + 1);
    }

    // Allocated Rates Matrix
    csv.rates = malloc(size * sizeof(double *));
    for (i = 0; i < size; i++) {
        csv.rates[i] = malloc(size * sizeof(double));
    }

    // Populate Columns Array
    for (i = 0; i < CsvParser_getNumFields(header); i++) {
        const char *s = headerFields[i];
        csv.columns[i] = s;
    }

    // Populate Rates Matrix
    i = 0;
    while ((row = CsvParser_getRow(csvparser))) {
        const char **rowFields = CsvParser_getFields(row);
        for (j = 0; j < CsvParser_getNumFields(row); j++) {
            double test = atof(rowFields[j]);
            csv.rates[i][j] = test;
        }
        CsvParser_destroy_row(row);
        i++;
    }

    CsvParser_destroy(csvparser);
    return csv;
}
